<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>launchpad-mk3-lightshow-studio</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --header-bg: #252525;
            --text-main: #e0e0e0;
            --accent: #00bcd4;
            --pad-base: #2c2c2c;
            --gap: 6px;
            --pad-size: 50px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', monospace, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .visualizer-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            position: relative;
        }

        .launchpad-body {
            background-color: #000;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.6);
            border: 2px solid #333;
        }

        .controls-sidebar {
            width: 360px;
            background-color: var(--panel-bg);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* --- COMPACT HEADER --- */
        .sidebar-header {
            padding: 12px 15px;
            background-color: var(--header-bg);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 0.85rem;
            color: #888;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #444;
            background: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .icon-btn:hover {
            border-color: #fff;
            transform: scale(1.1);
        }

        /* CONNECT BUTTON STYLES & ANIMATION */
        @keyframes glowing {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
                border-color: #4caf50;
            }

            50% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
                border-color: #81c784;
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                border-color: #4caf50;
            }
        }

        #connectBtn {
            color: #4caf50;
        }

        #connectBtn.attention {
            animation: glowing 2s infinite;
            background: rgba(76, 175, 80, 0.1);
        }

        #connectBtn.connected {
            background: #4caf50;
            color: #fff;
            box-shadow: 0 0 10px #4caf50;
            animation: none;
        }

        #exitBtn {
            color: #f44336;
        }

        #exitBtn:hover {
            background: #d32f2f;
            color: white;
        }

        .sidebar-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        /* --- SECTIONS --- */
        h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #666;
            margin: 20px 0 8px 0;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        /* --- EMOJI GRID --- */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .anim-btn {
            background: #2b2b2b;
            border: 1px solid #3d3d3d;
            border-radius: 6px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .anim-btn:hover {
            background: #444;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .anim-btn:active {
            transform: translateY(0);
        }

        .anim-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* --- PADS --- */
        .lp-row {
            display: flex;
            gap: var(--gap);
            margin-bottom: var(--gap);
        }

        .lp-row.top {
            margin-bottom: 15px;
        }

        .pad {
            width: var(--pad-size);
            height: var(--pad-size);
            background: var(--pad-base);
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.05s;
        }

        .pad.round {
            border-radius: 50%;
        }

        /* --- PALETTE & CONTROLS --- */
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }

        .swatch {
            aspect-ratio: 1;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .swatch.active {
            border-color: #fff;
            transform: scale(1.1);
            z-index: 2;
        }

        input[type="text"] {
            width: 100%;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 6px;
            border-radius: 4px;
        }

        .btn-full {
            width: 100%;
            padding: 8px;
            background: #333;
            color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .btn-full:hover {
            background: #444;
            color: #fff;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        textarea {
            width: 100%;
            height: 50px;
            background: #000;
            color: #0f0;
            border: 1px solid #333;
            font-family: monospace;
            font-size: 0.7rem;
            resize: none;
            margin-top: 5px;
        }

        .sidebar-footer {
            padding: 10px;
            background: #181818;
            border-top: 1px solid #333;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="visualizer-area">
            <div class="launchpad-body" id="gridContainer"></div>
        </div>

        <aside class="controls-sidebar">
            <div class="sidebar-header">
                <h1 class="app-title">launchpad-mk3-lightshow-studio</h1>
                <div class="header-actions">
                    <button id="connectBtn" class="icon-btn attention" title="Connect (Programmer Mode)">üîå</button>
                    <button id="exitBtn" class="icon-btn" title="Exit to Live Mode">‚ùå</button>
                </div>
            </div>

            <div class="sidebar-content">
                <div id="statusMsg" style="font-size: 0.75rem; color: #555; margin-bottom: 10px; text-align: right;">
                    Disconnected</div>

                <h3>Animations (14)</h3>
                <div class="emoji-grid">
                    <button class="anim-btn" title="Matrix Rain" onclick="runAnim('matrix', this)">üü¢</button>
                    <button class="anim-btn" title="Police Lights" onclick="runAnim('police', this)">üöì</button>
                    <button class="anim-btn" title="Heartbeat" onclick="runAnim('heart', this)">‚ù§Ô∏è</button>
                    <button class="anim-btn" title="Sunset Gradient" onclick="runAnim('sunset', this)">üåÖ</button>

                    <button class="anim-btn" title="Scanline" onclick="runAnim('scan', this)">üì°</button>
                    <button class="anim-btn" title="Snake Game" onclick="runAnim('snake', this)">üêç</button>
                    <button class="anim-btn" title="Digital Noise" onclick="runAnim('noise', this)">üé≤</button>
                    <button class="anim-btn" title="Converge" onclick="runAnim('converge', this)">üî≥</button>

                    <button class="anim-btn" title="Loading Bar" onclick="runAnim('loading', this)">‚è≥</button>
                    <button class="anim-btn" title="Sparkles" onclick="runAnim('sparkle', this)">‚ú®</button>
                    <button class="anim-btn" title="Checkers" onclick="runAnim('checkers', this)">üèÅ</button>
                    <button class="anim-btn" title="Ripple (Water)" onclick="runAnim('ripple', this)">üíß</button>

                    <button class="anim-btn" title="Fade (Breathing)" onclick="runAnim('fade', this)">üå¨Ô∏è</button>
                    <button class="anim-btn" title="Rainbow Scroll" onclick="runAnim('rainbow', this)">üåà</button>
                </div>

                <button class="btn-full btn-danger" onclick="stopEverything()">üõë STOP / BLACKOUT</button>

                <h3>Manual Paint</h3>
                <div class="palette-grid" id="palette"></div>
                <div style="font-size: 0.75rem; display: flex; gap: 10px; margin-top: 5px;">
                    <label><input type="radio" name="mode" value="00" checked> Static</label>
                    <label><input type="radio" name="mode" value="01"> Flash</label>
                    <label><input type="radio" name="mode" value="02"> Pulse</label>
                </div>

                <h3>Scrolling Text</h3>
                <input type="text" id="txtInput" placeholder="Enter text...">
                <button class="btn-full" onclick="sendText()">Send Text Loop</button>

                <h3>SysEx Output</h3>
                <textarea id="output" readonly></textarea>
            </div>

            <div class="sidebar-footer">
                <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                    data-name="bmc-button" data-slug="toniaczlog" data-color="#FF5F5F" data-emoji="" data-font="Cookie"
                    data-text="Buy me a food" data-outline-color="#000000" data-font-color="#ffffff"
                    data-coffee-color="#FFDD00"></script>
            </div>
        </aside>
    </div>

    <script>
        // --- CONFIG ---
        const SYSEX = [0xF0, 0x00, 0x20, 0x29, 0x02, 0x0D];
        const END = 0xF7;
        const colors = [
            { id: 0, h: '#222' }, { id: 5, h: '#f00' }, { id: 9, h: '#f70' }, { id: 13, h: '#ff0' },
            { id: 21, h: '#0f0' }, { id: 37, h: '#0af' }, { id: 45, h: '#05f' }, { id: 53, h: '#a0f' },
            { id: 95, h: '#f0a' }, { id: 3, h: '#fff' }, { id: 1, h: '#555' }, { id: 49, h: '#60f' },
            { id: 29, h: '#0fa' }, { id: 96, h: '#f55' }
        ];

        let midiOut = null;
        let loopTimer = null;
        let timeoutStore = [];
        let selectedColor = colors[1];

        // --- INIT ---
        window.onload = () => {
            buildGrid();
            buildPalette();
        };

        function buildGrid() {
            const cont = document.getElementById('gridContainer');
            const top = document.createElement('div'); top.className = 'lp-row top';
            top.appendChild(document.createElement('div'));
            for (let i = 1; i <= 8; i++) createPad(90 + i, top, 'round');
            cont.appendChild(top);
            for (let r = 8; r >= 1; r--) {
                const row = document.createElement('div'); row.className = 'lp-row';
                for (let c = 1; c <= 8; c++) createPad(r * 10 + c, row, '');
                createPad(r * 10 + 9, row, 'round');
                cont.appendChild(row);
            }
        }

        function createPad(idx, parent, cls) {
            const d = document.createElement('div');
            d.className = `pad ${cls}`; d.id = `p${idx}`;
            d.onmousedown = () => paint(idx);
            parent.appendChild(d);
        }

        function buildPalette() {
            const p = document.getElementById('palette');
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'swatch'; d.style.background = c.h;
                d.onclick = () => {
                    document.querySelectorAll('.swatch').forEach(x => x.classList.remove('active'));
                    d.classList.add('active'); selectedColor = c;
                }
                p.appendChild(d);
            });
        }

        // --- MIDI ---
        const getIdx = (r, c) => r * 10 + c;

        async function connect() {
            if (!navigator.requestMIDIAccess) return alert('No Web MIDI API');
            try {
                const acc = await navigator.requestMIDIAccess({ sysex: true });
                midiOut = Array.from(acc.outputs.values()).find(o => o.name.includes('Launchpad') || o.name.includes('LPMini'));
                if (midiOut) {
                    const btn = document.getElementById('connectBtn');
                    btn.classList.remove('attention');
                    btn.classList.add('connected');
                    document.getElementById('statusMsg').innerText = `Connected: ${midiOut.name}`;
                    send([0x0E, 0x01]); // Programmer Mode
                } else alert('Device not found');
            } catch (e) { console.log(e); }
        }

        document.getElementById('connectBtn').onclick = connect;
        document.getElementById('exitBtn').onclick = () => {
            stopEverything();
            setTimeout(() => send([0x0E, 0x00]), 100);
        };

        function send(bytes) {
            const msg = [...SYSEX, ...bytes, END];
            if (midiOut) midiOut.send(msg);
            document.getElementById('output').value = msg.map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' ');
        }

        function updatePad(idx, colId, mode = 0) {
            const el = document.getElementById(`p${idx}`);
            if (el) {
                const c = colors.find(x => x.id === colId) || { h: '#222' };
                el.style.background = colId === 0 ? '#2c2c2c' : c.h;
                el.style.boxShadow = colId === 0 ? 'none' : `0 0 10px ${c.h}`;

                // CSS Animation
                el.style.animation = 'none';
                el.offsetHeight; // reflow
                if (mode === 1) el.style.animation = 'blink 0.5s infinite alternate';
                if (mode === 2) el.style.animation = 'pulse 1s infinite ease-in-out';
            }

            if (midiOut) {
                if (colId === 0) {
                    send([0x03, 0x00, idx, 0x00]);
                } else {
                    if (mode === 1) {
                        // FIX: Flash needs 2 bytes (Color B, Color A)
                        // B=0 (off), A=colId
                        send([0x03, 0x01, idx, 0x00, colId]);
                    } else {
                        // Static/Pulse needs 1 byte
                        send([0x03, mode, idx, colId]);
                    }
                }
            }
        }

        function paint(idx) {
            const m = parseInt(document.querySelector('input[name="mode"]:checked').value);
            updatePad(idx, selectedColor.id, m);
        }

        // --- ANIMATION ENGINE ---

        function wipeDevice() {
            // Chunk 1: Grid (11-55)
            let chunk1 = [0x03];
            for (let i = 11; i <= 55; i++) { chunk1.push(0x00, i, 0x00); }
            if (midiOut) send(chunk1);

            // Chunk 2: Grid (56-89) + Top (91-98)
            let chunk2 = [0x03];
            for (let i = 56; i <= 89; i++) { chunk2.push(0x00, i, 0x00); }
            for (let i = 91; i <= 98; i++) { chunk2.push(0x00, i, 0x00); }
            if (midiOut) send(chunk2);
        }

        function stopEverything() {
            if (loopTimer) clearInterval(loopTimer);
            loopTimer = null;

            timeoutStore.forEach(t => clearTimeout(t));
            timeoutStore = [];

            document.querySelectorAll('.anim-btn').forEach(b => b.classList.remove('active'));

            if (midiOut) midiOut.send([...SYSEX, 0x07, END]); // Stop Text

            wipeDevice();

            document.querySelectorAll('.pad').forEach(p => {
                p.style.background = '#2c2c2c'; p.style.boxShadow = 'none'; p.style.animation = 'none';
            });
        }

        function runAnim(type, btn) {
            stopEverything();
            if (btn) btn.classList.add('active');

            setTimeout(() => {
                switch (type) {
                    case 'matrix': animMatrix(); break;
                    case 'police': animPolice(); break;
                    case 'heart': animHeart(); break;
                    case 'sunset': animSunset(); break;
                    case 'scan': animScan(); break;
                    case 'snake': animSnake(); break;
                    case 'noise': animNoise(); break;
                    case 'converge': animConverge(); break;
                    case 'loading': animLoading(); break;
                    case 'sparkle': animSparkle(); break;
                    case 'checkers': animCheckers(); break;
                    case 'ripple': animRipple(); break;
                    case 'fade': animFade(); break;
                    case 'rainbow': animRainbow(); break;
                }
            }, 50);
        }

        // --- ANIMATIONS ---

        function animMatrix() {
            let drops = Array(9).fill().map(() => Math.random() * 20);
            loopTimer = setInterval(() => {
                for (let c = 1; c <= 8; c++) {
                    drops[c] -= 0.5;
                    if (drops[c] < -5) drops[c] = 9 + Math.random() * 5;
                    const head = Math.floor(drops[c]);
                    for (let r = 1; r <= 8; r++) {
                        let col = 0;
                        if (r === head) col = 3;
                        else if (r === head + 1) col = 21;
                        else if (r === head + 2) col = 87;
                        if (col === 87) col = 21;
                        updatePad(getIdx(r, c), col);
                    }
                }
            }, 80);
        }

        function animPolice() {
            let tick = 0;
            loopTimer = setInterval(() => {
                tick = !tick;
                for (let r = 1; r <= 8; r++) {
                    for (let c = 1; c <= 4; c++) updatePad(getIdx(r, c), tick ? 5 : 0);
                    for (let c = 5; c <= 8; c++) updatePad(getIdx(r, c), tick ? 0 : 45);
                }
            }, 300);
        }

        function animHeart() {
            const map = [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            for (let r = 1; r <= 8; r++) {
                for (let c = 1; c <= 8; c++) {
                    const i = (8 - r) * 8 + (c - 1);
                    if (map[i]) updatePad(getIdx(r, c), 5, 2);
                }
            }
        }

        function animSnake() {
            let snake = [{ r: 4, c: 4 }, { r: 4, c: 3 }];
            let dir = { r: 0, c: 1 };
            loopTimer = setInterval(() => {
                let h = { r: snake[0].r + dir.r, c: snake[0].c + dir.c };
                if (h.r > 8 || h.r < 1 || h.c > 8 || h.c < 1) {
                    h = snake[0];
                    if (dir.r === 0) dir = { r: Math.random() > .5 ? 1 : -1, c: 0 };
                    else dir = { r: 0, c: Math.random() > .5 ? 1 : -1 };
                }
                if (Math.random() > .8) {
                    if (dir.r === 0) dir = { r: Math.random() > .5 ? 1 : -1, c: 0 };
                    else dir = { r: 0, c: Math.random() > .5 ? 1 : -1 };
                }
                snake.unshift(h);
                const tail = snake.pop();
                updatePad(getIdx(tail.r, tail.c), 0);
                snake.forEach((s, i) => updatePad(getIdx(s.r, s.c), i === 0 ? 3 : 21));
            }, 120);
        }

        function animSparkle() {
            loopTimer = setInterval(() => {
                const r = Math.ceil(Math.random() * 8);
                const c = Math.ceil(Math.random() * 8);
                const idx = getIdx(r, c);
                updatePad(idx, 3);
                const t = setTimeout(() => updatePad(idx, 0), 100);
                timeoutStore.push(t);
            }, 40);
        }

        function animRipple() {
            let radius = 0;
            loopTimer = setInterval(() => {
                radius = (radius + 1) % 12;
                const centerR = 4.5, centerC = 4.5;
                for (let r = 1; r <= 8; r++) {
                    for (let c = 1; c <= 8; c++) {
                        const d = Math.sqrt(Math.pow(r - centerR, 2) + Math.pow(c - centerC, 2));
                        if (d >= radius - 1 && d < radius) updatePad(getIdx(r, c), 37);
                        else if (d >= radius - 2 && d < radius - 1) updatePad(getIdx(r, c), 45);
                        else updatePad(getIdx(r, c), 0);
                    }
                }
            }, 80);
        }

        function animRainbow() {
            let offset = 0;
            const pal = [5, 9, 13, 21, 37, 45, 53, 95];
            loopTimer = setInterval(() => {
                offset++;
                for (let r = 1; r <= 8; r++) {
                    for (let c = 1; c <= 8; c++) {
                        const i = Math.floor((r + c + offset) / 2) % pal.length;
                        updatePad(getIdx(r, c), pal[i]);
                    }
                }
            }, 100);
        }

        function animSunset() {
            const rows = [13, 13, 9, 9, 95, 95, 53, 53];
            for (let r = 1; r <= 8; r++) {
                for (let c = 1; c <= 8; c++) updatePad(getIdx(r, c), rows[8 - r]);
            }
        }

        function animScan() {
            let y = 0;
            loopTimer = setInterval(() => {
                y = (y + 1) % 9;
                for (let r = 1; r <= 8; r++) {
                    const col = r === y ? 3 : (r === y - 1 ? 21 : 0);
                    for (let c = 1; c <= 8; c++) updatePad(getIdx(r, c), col);
                }
            }, 100);
        }

        function animConverge() {
            let frame = 0;
            loopTimer = setInterval(() => {
                frame = (frame + 1) % 6;
                if (frame > 4) {
                    wipeDevice();
                    return;
                }
                const min = 1 + frame, max = 8 - frame;
                for (let r = min; r <= max; r++) {
                    for (let c = min; c <= max; c++) {
                        if (r === min || r === max || c === min || c === max) updatePad(getIdx(r, c), 95);
                    }
                }
            }, 150);
        }

        function animLoading() {
            let i = 0;
            loopTimer = setInterval(() => {
                if (i > 63) { i = 0; wipeDevice(); return; }
                const r = Math.floor(i / 8) + 1, c = (i % 8) + 1;
                updatePad(getIdx(r, c), 37);
                i++;
            }, 30);
        }

        function animNoise() {
            loopTimer = setInterval(() => {
                for (let k = 0; k < 15; k++) {
                    const r = Math.ceil(Math.random() * 8), c = Math.ceil(Math.random() * 8);
                    const col = colors[Math.floor(Math.random() * colors.length)].id;
                    updatePad(getIdx(r, c), col);
                }
            }, 60);
        }

        function animCheckers() {
            let flip = false;
            loopTimer = setInterval(() => {
                flip = !flip;
                for (let r = 1; r <= 8; r++) {
                    for (let c = 1; c <= 8; c++) {
                        const on = (r + c) % 2 === (flip ? 0 : 1);
                        updatePad(getIdx(r, c), on ? 3 : 0);
                    }
                }
            }, 400);
        }

        function animFade() {
            let hue = 0;
            loopTimer = setInterval(() => {
                hue = (hue + 1) % colors.length;
                const c = colors[hue].id;
                if (c === 0) return;
                for (let i = 11; i <= 88; i++) if (i % 10 != 0 && i % 10 != 9) updatePad(i, c, 2);
            }, 2000);
        }

        // --- TEXT ---
        function sendText() {
            stopEverything();
            const txt = document.getElementById('txtInput').value;
            if (!txt) return;
            const bytes = txt.split('').map(c => c.charCodeAt(0));
            setTimeout(() => send([0x07, 0x01, 15, 0x00, 37, ...bytes]), 100);
        }

        // CSS for Visuals
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        @keyframes pulse { 0% { opacity: 0.4; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1); } 100% { opacity: 0.4; transform: scale(0.95); } }
    `;
        document.head.appendChild(styleSheet);

    </script>
</body>

</html>